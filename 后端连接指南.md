# FastAPI + Vue 前后端分离项目连接指南

## 项目概述
这是一个基于Vue 3的DeepSeek聊天应用前端项目，后端使用FastAPI框架。本文档详细指导您如何修改前端代码连接FastAPI后端。

## 技术栈说明

### 前端技术栈：
- **框架**: Vue 3 + Composition API
- **构建工具**: Vite (运行在3000端口)
- **HTTP客户端**: Axios
- **状态管理**: Vue内置响应式系统
- **UI组件**: 原生HTML + Tailwind CSS

### 后端技术栈：
- **框架**: FastAPI (运行在8000端口，默认FastAPI端口)
- **认证**: JWT Token
- **数据库**: 根据您的FastAPI项目配置
- **WebSocket**: 可选，FastAPI支持

## 连接前准备工作

### 1. 确认FastAPI后端信息
请确认您的FastAPI项目：
- 运行端口（默认8000）
- API路径前缀（如`/api`）
- 认证方式（JWT token格式）
- CORS是否已配置

## 第一步：环境变量配置

### 1. 创建环境变量文件
**新建文件**: `.env.development`
```env
# FastAPI后端地址（默认端口8000）
VITE_API_BASE_URL=http://localhost:8000/api
VITE_APP_NAME=DeepSeek Chat
# WebSocket地址（如果FastAPI支持WebSocket）
VITE_WS_URL=ws://localhost:8000/ws
```

**新建文件**: `.env.production`
```env
# 生产环境FastAPI地址
VITE_API_BASE_URL=https://your-fastapi-domain.com/api
VITE_APP_NAME=DeepSeek Chat
VITE_WS_URL=wss://your-fastapi-domain.com/ws
```

### 2. 安装依赖
在项目根目录运行：
```bash
# 安装HTTP客户端
npm install axios

# 如果需要WebSocket支持（FastAPI通常使用标准WebSocket）
npm install socket.io-client
```

## 第二步：创建API服务模块

### 1. 创建API服务文件
**新建文件**: `src/services/api.js`

```javascript
import axios from 'axios'

// 从环境变量获取FastAPI地址
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:8000/api'

// 创建axios实例，配置FastAPI连接
const apiClient = axios.create({
  baseURL: API_BASE_URL,
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json',
    'Accept': 'application/json'
  }
})

// 请求拦截器 - 为FastAPI添加JWT Token
apiClient.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('authToken')
    if (token) {
      // FastAPI通常使用Bearer token认证
      config.headers.Authorization = `Bearer ${token}`
    }
    return config
  },
  (error) => {
    return Promise.reject(error)
  }
)

// 响应拦截器 - 处理FastAPI返回的错误
apiClient.interceptors.response.use(
  (response) => {
    // FastAPI通常直接返回数据对象
    return response.data
  },
  (error) => {
    // FastAPI错误处理
    if (error.response?.status === 401) {
      // JWT token过期或无效
      localStorage.removeItem('authToken')
      localStorage.removeItem('userInfo')
      window.location.reload()
    } else if (error.response?.status === 422) {
      // FastAPI数据验证错误
      console.error('数据验证错误:', error.response.data)
    }
    
    // 网络错误处理
    if (!error.response) {
      console.error('无法连接到FastAPI后端:', error.message)
      throw new Error('无法连接到后端服务，请检查FastAPI是否启动')
    }
    
    return Promise.reject(error)
  }
)

// FastAPI认证接口
export const authAPI = {
  // 用户登录 - 对应FastAPI的 /api/auth/login
  login: (credentials) => apiClient.post('/auth/login', credentials),
  
  // 用户注册 - 对应FastAPI的 /api/auth/register
  register: (userData) => apiClient.post('/auth/register', userData),
  
  // 获取用户信息 - 对应FastAPI的 /api/auth/me
  getCurrentUser: () => apiClient.get('/auth/me'),
  
  // 刷新token - 对应FastAPI的 /api/auth/refresh
  refreshToken: () => apiClient.post('/auth/refresh'),
  
  // 用户登出 - 对应FastAPI的 /api/auth/logout
  logout: () => apiClient.post('/auth/logout')
}

// FastAPI聊天接口
export const chatAPI = {
  // 获取聊天列表 - 对应FastAPI的 /api/chats/
  getChats: () => apiClient.get('/chats/'),
  
  // 创建新聊天 - 对应FastAPI的 /api/chats/
  createChat: (title) => apiClient.post('/chats/', { title }),
  
  // 删除聊天 - 对应FastAPI的 /api/chats/{chat_id}
  deleteChat: (chatId) => apiClient.delete(`/chats/${chatId}`),
  
  // 获取聊天消息 - 对应FastAPI的 /api/chats/{chat_id}/messages
  getMessages: (chatId) => apiClient.get(`/chats/${chatId}/messages`),
  
  // 发送消息 - 对应FastAPI的 /api/chats/{chat_id}/messages
  sendMessage: (chatId, content) => apiClient.post(`/chats/${chatId}/messages`, { content }),
  
  // 流式消息（如果FastAPI支持）
  streamMessage: (chatId, content) => apiClient.post(`/chats/${chatId}/stream`, { content })
}

// WebSocket连接（FastAPI支持标准WebSocket）
export const createWebSocket = (token) => {
  const WS_URL = import.meta.env.VITE_WS_URL || 'ws://localhost:8000/ws'
  return new WebSocket(`${WS_URL}?token=${token}`)
}

export default apiClient
```

## 第三步：修改前端代码连接FastAPI

### 1. 修改登录组件 - LoginModal.vue
**文件位置**: `src/components/LoginModal.vue`

在methods中找到handleLogin方法，修改为：

```javascript
async handleLogin() {
  if (!this.loginForm.username || !this.loginForm.password) {
    this.toast.error('请输入用户名和密码')
    return
  }

  this.loading = true
  
  try {
    // 导入API服务
    const { authAPI } = await import('@/services/api')
    
    // 调用FastAPI登录接口
    const response = await authAPI.login({
      username: this.loginForm.username,
      password: this.loginForm.password
    })
    
    // FastAPI返回格式通常为 { access_token, token_type, user }
    const { access_token, user } = response
    
    // 存储token和用户信息
    localStorage.setItem('authToken', access_token)
    localStorage.setItem('userInfo', JSON.stringify(user))
    
    // 触发登录成功事件
    this.$emit('login-success', user)
    
    // 显示成功提示
    this.toast.success('登录成功')
    
    // 关闭登录弹窗
    this.showLoginModal = false
    
    // 重置表单
    this.loginForm = {
      username: '',
      password: ''
    }
    
  } catch (error) {
    console.error('登录失败:', error)
    
    // FastAPI错误处理
    if (error.response?.status === 401) {
      this.toast.error('用户名或密码错误')
    } else if (error.response?.status === 422) {
      this.toast.error('数据格式错误，请检查输入')
    } else if (error.message.includes('无法连接到后端服务')) {
      this.toast.error('无法连接到FastAPI后端，请检查服务是否启动')
    } else {
      this.toast.error('登录失败，请稍后重试')
    }
  } finally {
    this.loading = false
  }
}
```

### 2. 修改主应用文件 - App.vue
**文件位置**: `src/App.vue`

#### 2.1 导入API服务
在script部分添加导入：
```javascript
import { authAPI, chatAPI } from '@/services/api'
```

#### 2.2 修改登录成功处理
在methods中找到handleLoginSuccess方法，修改为：

```javascript
async handleLoginSuccess(userInfo) {
  this.isAuthenticated = true
  this.userInfo = userInfo
  
  try {
    // 从FastAPI获取用户聊天列表
    const chats = await chatAPI.getChats()
    this.chats = chats
    
    this.toast.success('登录成功')
  } catch (error) {
    console.error('获取聊天列表失败:', error)
    this.toast.error('获取聊天数据失败')
  }
}
```

#### 2.3 修改退出登录处理
在methods中找到handleLogout方法，修改为：

```javascript
async handleLogout() {
  try {
    // 调用FastAPI登出接口
    await authAPI.logout()
  } catch (error) {
    console.error('登出失败:', error)
  } finally {
    // 清除本地存储
    localStorage.removeItem('authToken')
    localStorage.removeItem('userInfo')
    
    this.isAuthenticated = false
    this.userInfo = null
    this.chats = []
    this.currentChat = null
    
    this.toast.info('已退出登录')
  }
}
```

#### 2.4 修改聊天相关方法
在methods中修改聊天相关方法：

```javascript
// 创建新聊天
async newChat() {
  try {
    const newChat = await chatAPI.createChat('新对话')
    this.chats.unshift(newChat)
    this.selectChat(newChat.id)
  } catch (error) {
    this.toast.error('创建聊天失败')
  }
}

// 选择聊天
async selectChat(chatId) {
  try {
    const messages = await chatAPI.getMessages(chatId)
    this.currentChat = { id: chatId, messages }
  } catch (error) {
    this.toast.error('加载聊天记录失败')
  }
}

// 删除聊天
async deleteChat(chatId) {
  try {
    await chatAPI.deleteChat(chatId)
    this.chats = this.chats.filter(chat => chat.id !== chatId)
    if (this.currentChat?.id === chatId) {
      this.currentChat = null
    }
    this.toast.success('删除成功')
  } catch (error) {
    this.toast.error('删除失败')
  }
}

// 发送消息
async sendMessage(content) {
  if (!this.currentChat) return
  
  try {
    const response = await chatAPI.sendMessage(this.currentChat.id, content)
    // 处理消息响应
    this.currentChat.messages.push(response)
  } catch (error) {
    this.toast.error('发送消息失败')
  }
}
```

## 前后端分离架构下的主要修改

### 1. 登录功能 - LoginModal.vue
**文件位置**: `src/components/LoginModal.vue`

修改`handleLogin`方法，添加后端连接逻辑：
```javascript
async handleLogin() {
  if (!this.loginForm.identifier || !this.loginForm.password) {
    this.toast.error('请输入用户名/邮箱和密码')
    return
  }
  
  try {
    this.isLoading = true
    
    // 调用后端API进行认证
    const response = await authAPI.login({
      identifier: this.loginForm.identifier,
      password: this.loginForm.password
    })
    
    // 保存认证信息到本地存储
    localStorage.setItem('authToken', response.token)
    localStorage.setItem('userInfo', JSON.stringify(response.user))
    localStorage.setItem('refreshToken', response.refreshToken) // 如果有刷新token
    
    // 触发登录成功事件
    this.$emit('login-success', response.user)
    this.toast.success('登录成功')
    
    // 关闭登录弹窗
    this.showLoginModal = false
    
  } catch (error) {
    console.error('登录失败:', error)
    
    // 根据错误类型显示不同的提示信息
    if (error.message.includes('网络连接失败')) {
      this.toast.error('无法连接到后端服务，请检查后端是否启动')
    } else if (error.response?.status === 401) {
      this.toast.error('用户名或密码错误')
    } else if (error.response?.status === 404) {
      this.toast.error('后端服务未找到，请检查API地址配置')
    } else {
      this.toast.error(error.response?.data?.message || '登录失败，请稍后重试')
    }
  } finally {
    this.isLoading = false
  }
}
```

### 2. 聊天列表获取 - App.vue
**文件位置**: `src/App.vue`

修改mounted钩子中的用户信息获取：
```javascript
mounted() {
  // 检查登录状态
  const token = localStorage.getItem('authToken')
  if (token) {
    this.loadUserInfo()
  }
  
  // ... 其他现有代码
},

methods: {
  // 加载用户信息
  async loadUserInfo() {
    try {
      const userInfo = await authAPI.getUserInfo()
      this.isLoggedIn = true
      this.userInfo = userInfo
    } catch (error) {
      console.error('获取用户信息失败:', error)
      localStorage.removeItem('authToken')
    }
  },
  
  // 修改登录成功处理
  async handleLoginSuccess(userData) {
    this.isLoggedIn = true
    this.userInfo = userData
    
    // 加载聊天列表
    await this.loadChats()
  },
  
  // 加载聊天列表
  async loadChats() {
    try {
      const chats = await chatAPI.getChats()
      this.recentChats = chats.map(chat => ({
        id: chat.id,
        title: chat.title,
        time: this.formatTime(chat.updatedAt),
        color: 'bg-blue-100',
        iconColor: 'text-blue-500'
      }))
    } catch (error) {
      console.error('加载聊天列表失败:', error)
      this.toast.error('加载聊天列表失败')
    }
  }
}
```

### 3. 发送消息功能 - App.vue
**文件位置**: `src/App.vue`

修改`sendMessage`方法：
```javascript
async sendMessage(content) {
  if (!content.trim()) return
  
  if (!this.selectedChatId) {
    // 如果没有选中聊天，先创建新聊天
    await this.createNewChatAndSend(content)
    return
  }
  
  try {
    // 添加用户消息到界面
    const userMessage = {
      id: Date.now(),
      role: 'user',
      content: content.trim(),
      timestamp: Date.now()
    }
    this.currentMessages.push(userMessage)
    
    // 清空输入框
    this.inputMessage = ''
    
    // 发送到后端
    this.isLoading = true
    const response = await chatAPI.sendMessage(this.selectedChatId, content.trim())
    
    // 添加AI回复到界面
    const aiMessage = {
      id: response.id,
      role: 'assistant',
      content: response.content,
      timestamp: response.timestamp
    }
    this.currentMessages.push(aiMessage)
    
  } catch (error) {
    console.error('发送消息失败:', error)
    this.toast.error('发送消息失败')
  } finally {
    this.isLoading = false
  }
},

// 创建新聊天并发送消息
async createNewChatAndSend(content) {
  try {
    this.isLoading = true
    
    // 创建新聊天
    const chatResponse = await chatAPI.createChat('新对话')
    const newChat = {
      id: chatResponse.id,
      title: '新对话',
      time: '刚刚',
      color: 'bg-blue-100',
      iconColor: 'text-blue-500'
    }
    
    this.recentChats.unshift(newChat)
    this.selectedChatId = newChat.id
    
    // 发送消息
    await this.sendMessage(content)
    
  } catch (error) {
    console.error('创建聊天失败:', error)
    this.toast.error('创建聊天失败')
  } finally {
    this.isLoading = false
  }
}
```

### 4. 聊天操作 - App.vue
**文件位置**: `src/App.vue`

修改相关方法：
```javascript
// 创建新聊天
async newChat() {
  try {
    const response = await chatAPI.createChat('新对话')
    
    const newChat = {
      id: response.id,
      title: '新对话',
      time: '刚刚',
      color: 'bg-blue-100',
      iconColor: 'text-blue-500'
    }
    
    this.recentChats.unshift(newChat)
    this.selectedChatId = newChat.id
    this.currentMessages = []
    this.toast.info('已创建新对话')
    
  } catch (error) {
    console.error('创建聊天失败:', error)
    this.toast.error('创建聊天失败')
  }
},

// 删除聊天
async deleteChat(chatId) {
  try {
    await chatAPI.deleteChat(chatId)
    
    const index = this.recentChats.findIndex(chat => chat.id === chatId)
    if (index !== -1) {
      this.recentChats.splice(index, 1)
      if (this.selectedChatId === chatId) {
        this.selectedChatId = this.recentChats.length > 0 ? this.recentChats[0].id : null
        this.currentMessages = []
      }
      this.toast.success('对话已删除')
    }
    
  } catch (error) {
    console.error('删除聊天失败:', error)
    this.toast.error('删除聊天失败')
  }
},

// 选择聊天并加载消息
async selectChat(chatId) {
  this.selectedChatId = chatId
  await this.loadChatMessages(chatId)
},

// 加载聊天消息
async loadChatMessages(chatId) {
  try {
    const messages = await chatAPI.getMessages(chatId)
    this.currentMessages = messages.map(msg => ({
      id: msg.id,
      role: msg.role,
      content: msg.content,
      timestamp: msg.timestamp
    }))
  } catch (error) {
    console.error('加载消息失败:', error)
    this.toast.error('加载消息失败')
  }
}
```

## 环境配置

### 开发环境配置
创建 `.env.development` 文件：
```env
VITE_API_BASE_URL=http://localhost:3001/api
VITE_APP_NAME=DeepSeek Chat
```

### 生产环境配置
创建 `.env.production` 文件：
```env
VITE_API_BASE_URL=https://your-production-domain.com/api
VITE_APP_NAME=DeepSeek Chat
```

## 前后端分离架构注意事项

### 1. CORS跨域配置
后端项目必须配置CORS，允许前端域名访问：

**Express.js示例**:
```javascript
app.use(cors({
  origin: ['http://localhost:3000', 'https://your-frontend-domain.com'],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS']
}))
```

**FastAPI示例**:
```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000", "https://your-frontend-domain.com"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### 2. 数据格式约定
前后端数据格式需要保持一致：

**请求格式**:
```json
{
  "identifier": "username@example.com",
  "password": "password123"
}
```

**响应格式**:
```json
{
  "success": true,
  "data": {
    "user": {
      "id": 1,
      "username": "testuser",
      "email": "test@example.com"
    },
    "token": "jwt_token_here",
    "refreshToken": "refresh_token_here"
  },
  "message": "登录成功"
}
```

### 3. 后端API接口规范

#### 认证接口
- `POST /api/auth/login` - 用户登录
- `POST /api/auth/register` - 用户注册  
- `GET /api/auth/user` - 获取用户信息
- `POST /api/auth/refresh` - 刷新token
- `POST /api/auth/logout` - 用户登出

#### 聊天接口
- `GET /api/chats` - 获取聊天列表
- `POST /api/chats` - 创建新聊天
- `DELETE /api/chats/:id` - 删除聊天
- `GET /api/chats/:id/messages` - 获取聊天消息
- `POST /api/chats/:id/messages` - 发送消息
- `POST /api/chats/:id/stream` - 流式消息（可选）

#### WebSocket接口（可选）
- `ws://localhost:3001/chat` - 实时聊天连接

## 部署配置

### 开发环境部署
1. **启动后端**: 在backend项目运行 `npm run dev` 或相应启动命令
2. **启动前端**: 在前端项目运行 `npm run dev`
3. **验证连接**: 访问 http://localhost:3000 测试功能

### 生产环境部署
1. **构建前端**: `npm run build`
2. **部署前端**: 将dist目录部署到Nginx或CDN
3. **部署后端**: 部署到服务器或云平台
4. **配置代理**: 配置Nginx反向代理到后端API

## 测试流程

### 1. 连接测试
```bash
# 测试后端API是否可达
curl http://localhost:3001/api/health
```

### 2. 功能测试步骤
1. 启动后端服务（确保运行在3001端口）
2. 修改前端环境变量配置
3. 运行 `npm run dev` 启动前端
4. 打开浏览器访问 http://localhost:3000
5. 测试登录功能（检查网络请求）
6. 测试聊天功能（检查消息发送/接收）

## 故障排除指南

### 常见问题及解决方案

**问题1: CORS错误**
```
Access to fetch at 'http://localhost:3001/api/auth/login' from origin 'http://localhost:3000' has been blocked by CORS policy
```
**解决**: 检查后端CORS配置，确保包含前端域名

**问题2: 网络连接失败**
```
Network Error: 无法连接到后端服务
```
**解决**: 
- 检查后端服务是否启动
- 检查防火墙设置
- 验证API地址配置

**问题3: 401未授权**
```
401 Unauthorized
```
**解决**:
- 检查token是否有效
- 验证token格式是否正确
- 检查认证中间件配置

**问题4: 404接口不存在**
```
404 Not Found
```
**解决**:
- 检查API路径是否正确
- 验证后端路由配置
- 检查代理配置

### 调试技巧
1. **浏览器开发者工具**: 查看Network面板的请求/响应
2. **控制台日志**: 检查JavaScript错误信息
3. **后端日志**: 查看后端服务的运行日志
4. **API测试工具**: 使用Postman测试后端接口

## 性能优化建议

1. **请求合并**: 对于频繁的API调用，考虑合并请求
2. **缓存策略**: 合理使用浏览器缓存和CDN缓存
3. **图片优化**: 压缩图片，使用WebP格式
4. **代码分割**: 使用Vite的动态导入功能
5. **懒加载**: 对非关键资源实现懒加载